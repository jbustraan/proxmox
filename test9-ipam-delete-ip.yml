### script to test url: built-in
### test9 - phpipam - delete IP address
---
- hosts: localhost
  become: yes
  gather_facts: false

  tasks:
  - name: Login to API and get token 
    uri: 
      url: https://ipam.bustraan.lab/api/ipam1/user/
      user: apiuser
      method: POST
      password: APIforever22
      force_basic_auth: yes
      status_code: 200
      validate_certs: no
    register: _result

  - name: Print login _result
    debug: 
      msg: 
        - "{{ _result.status }}"
        - "{{ _result.json.data.token }}"
        - "{{ ansible_default_ipv4 }}"
          #- "{{ _result.cookies.phpipam }}"

  - name: Get IPAM ID of IP address to DELETE for VM "{{ ansible_hostname }}"
    uri:
      url: "https://ipam.bustraan.lab/api/ipam1/addresses/search/{{ ansible_default_ipv4 }}/"
      method: GET
      status_code: 
        - 200
        - 201
      validate_certs: no
      headers:
        "token": "{{ _result.json.data.token }}"
    register: _result2

  - name: Print new IP address
    debug: 
      msg: 
        - "{{ _result2.json.code }}"
        - "{{ _result2.json.data[0].id }}"

  - name: Delete IP address and associated DNS name with ID "{{ _result2.json.data[0].id }}" and IP "{{ _result2.json.data[0].ip }}"
    uri:
      url: "https://ipam.bustraan.lab/api/ipam1/addresses/{{ _result2.json.data[0].id }}/?remove_dns=1"
      method: DELETE
      status_code: 
        - 200
        - 201
      validate_certs: no
      headers:
        "token": "{{ _result.json.data.token }}"
    register: _result3

  - name: Show result of call
    debug:
      msg: "{{ _result3.json.message }}"


